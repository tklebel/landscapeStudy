---
title: "Landscape Study - General Overview"
author: Thomas Klebel
date: Last changed `r lubridate::today()`
output: 
  html_document:
    df_print: paged
    keep_md: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```


```{r, message=FALSE}
library(tidyverse)
library(RColorBrewer)
library(ggalt)
library(visdat)
library(here)
library(tidytext)
library(igraph)
library(ggraph)
source(here("R/helpers.R"))

theme_set(hrbrmisc::theme_hrbrmstr())


# import data
refined <- read_csv(here("data-transformed/refined.csv"))
refined_with_areas <- read_csv(here("data-transformed/refined_w_areas.csv"))

```

# Summary
The general impression is, that the journals most of the time do not have a 
specific policy regarding the aspect under question, or it was unclear for our
reviewers if there was a policy or not or how to interpret it.

# Missing data
```{r, fig.height=10, fig.width=10}
refined %>% 
  vis_miss()
```

There is quite some missing data, which shouldn't be like this. For example
the field U30 in excel (table RAW), which has the opr-responses for the journal
"Advanced Materials" is missing. It should probably be "Not specified".

The following are all variables, where implicit missings should be checked and
converted to explicit ones (as for opr_responses), or fixed (as for publishers).

```{r, fig.height=6, fig.width=8}
# only columns with missing data
with_missings <- refined %>% 
  select(-starts_with("G_"), -ends_with("clean")) %>% 
  select_if(~any(is.na(.))) %>% 
  # remove a few columns where missing data is ok
  select(-starts_with("review date"),
         -starts_with("To dis"),
         -starts_with("Time ta"),
         -starts_with("Review"),
         -starts_with("Free"),
         # Top journals are being removed as well, since these are legit 
         # missings
         -starts_with("Top journals in")
         )

with_missings %>% 
  vis_miss() +
  theme(plot.margin = margin(r = 50))
```

# Publisher versus subject area
The question is, whether it is reasonable to split results by publisher.
I think it does not make much sense:

- There are not many publishers, that have multiple publications
- Except Springer Nature and Elsevier, most publishers are confined to one or 
two subject areas. Looking at publishers would misinterprete differences as
being due to the publisher when they are due to the subject area.
- The only thing to compare would be thus Springer Nature vs. Elsevier


```{r, fig.width=12, fig.height=6}
refined %>% 
  count(publisher_clean, sort = T) %>% 
  filter(n > 4) %>% 
  left_join(refined_with_areas) %>% 
  count(publisher_clean, area) %>% 
  ggplot(aes(publisher_clean, str_wrap(area, 20), colour = n, size = n)) +
  geom_point() +
  viridis::scale_color_viridis() +
  coord_flip() +
  labs(x = NULL, y = NULL, title = "Journals by Publisher and subject area",
       colour = NULL, size = NULL) +
  theme(legend.position = "top")
```




# Peer Review
```{r}
# small tweaks
refined_with_areas <- refined_with_areas %>% 
  order_factors()
```


```{r, fig.width=12, fig.height=5}
ggplot(refined_with_areas, aes(str_wrap(area, 20), fill = pr_type_clean)) +
  geom_bar(position = "fill", width = .7) +
  # coord_flip() +
  scale_fill_brewer(palette = "Set3") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "top") +
  labs(fill = NULL, x = NULL, y = NULL, 
       title = "What type of peer review is used?")
```


```{r, fig.width=9, fig.height=8}
ggplot(refined_with_areas, aes(fct_rev(area), fill = area)) +
  geom_bar(show.legend = F) +
  facet_wrap(~pr_type_clean) +
  coord_flip() +
  labs(x = NULL, y = NULL, 
     title = "What type of peer review is used?")
```



```{r}
refined <- refined %>% 
  mutate(pr_database_clean = case_when(
    str_detect(pr_database, "^Yes") ~ "Yes",
    str_detect(pr_database, "Unsure") ~ "Unsure",
    str_detect(pr_database, "No") ~ "No"
  ))

refined %>% 
  plot_univariate(pr_database_clean) +
  coord_flip() +
  labs(title = "Is peer reviewer activity deposited into\nopen databases? (like Publons or ORCID)")
```


```{r, fig.width=12, fig.height=6}
refined_with_areas <- refined_with_areas %>% 
  mutate(pr_database_clean = case_when(
    str_detect(pr_database, "^Yes") ~ "Yes",
    str_detect(pr_database, "Unsure") ~ "Unsure",
    str_detect(pr_database, "No") ~ "No"
  ))

refined_with_areas %>% 
  mutate(pr_database_clean = fct_relevel(
    pr_database_clean,
    "Yes"
  )) %>% 
  plot_with_areas(pr_database_clean,
                  title = "Is peer reviewer activity deposited into open databases? (like Publons or ORCID)")

```




# Open Peer Review
```{r, fig.width=8, fig.height=7}
pdata <- refined %>% 
  select(opr_reports:opr_interaction) %>% 
  gather(var, val) %>% 
  mutate(val_clean = case_when(
    str_detect(val, "Conditional") ~ "Conditional",
    str_detect(str_to_lower(val), "not spec") ~ "Not specified",
    TRUE ~ val
  ))

labels <- pdata %>% 
  distinct(var) %>% 
  mutate(label = case_when(
    var == "opr_reports" ~ "Are peer review reports being published?",
    var == "opr_responses" ~ "Are author responses to reviews being published?",
    var == "opr_letters" ~ "Are editorial decision letters being published?",
    var == "opr_versions" ~ "Are previous versions of the manuscript being published?",
    var == "opr_identities_published" ~ "Are reviewer identities being published?",
    var == "opr_indenties_author" ~ "Are reviewer identities revealed to the author (even if not published)?",
    var == "opr_comments" ~ "Is there public commenting during formal peer review?",
    var == "opr_interaction" ~ "Is there open interaction (reviewers consult with one another)?"
  )) %>% 
mutate_at("label", ~str_wrap(., 40))

pdata %>% 
  left_join(labels) %>% 
  ggplot(., aes(label, fill = val_clean)) +
  geom_bar(position = "fill", width = .7) +
  coord_flip() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set3") +
  theme(legend.position = "top") +
  labs(x = NULL, y = NULL, fill = NULL) 
```

```{r, fig.height=12, fig.width=9}
pdata <- refined_with_areas %>% 
  select(area, opr_reports:opr_interaction) %>% 
  gather(var, val, -area) %>% 
  mutate(val_clean = case_when(
    str_detect(val, "Conditional") ~ "Conditional",
    str_detect(str_to_lower(val), "not spec") ~ "Not specified",
    TRUE ~ val
  ))

labels <- pdata %>% 
  distinct(var) %>% 
  mutate(label = case_when(
    var == "opr_reports" ~ "Are peer review reports being published?",
    var == "opr_responses" ~ "Are author responses to reviews being published?",
    var == "opr_letters" ~ "Are editorial decision letters being published?",
    var == "opr_versions" ~ "Are previous versions of the manuscript being published?",
    var == "opr_identities_published" ~ "Are reviewer identities being published?",
    var == "opr_indenties_author" ~ "Are reviewer identities revealed to the author (even if not published)?",
    var == "opr_comments" ~ "Is there public commenting during formal peer review?",
    var == "opr_interaction" ~ "Is there open interaction (reviewers consult with one another)?"
  )) %>% 
mutate_at("label", ~str_wrap(., 40))

pdata %>% 
  left_join(labels) %>% 
  ggplot(., aes(label, fill = val_clean)) +
  geom_bar(position = "fill", width = .7) +
  scale_y_continuous(labels = scales::percent) +
  coord_flip() +
  facet_wrap(~area) +
  theme(legend.position = "top") +
  labs(x = NULL, y = NULL, fill = NULL) 
# display via plotly was removed, so it could be rendered on GitHub
```



```{r, eval=FALSE}
# these plots have been incorporated above
refined %>% 
  plot_univariate(opr_identities_published) +
  coord_flip() 

refined %>% 
  plot_univariate(opr_indenties_author) +
  coord_flip()

refined %>% 
  plot_univariate(opr_comments) +
  coord_flip()

refined %>% 
  plot_univariate(opr_interaction) +
  coord_flip()
```

# Co-Review
Let's look at the co-review policy.

```{r}
coreview_policies <- refined %>% 
  select(coreview_policy) %>% 
  filter(!is.na(coreview_policy),
         !(coreview_policy %in% c("Not specified", "Not found")))
```

Only `r nrow(coreview_policies)` out of `r nrow(refined)` do have a 
coreview-policy. Due to policies being similar across journals of certain 
publishers, there are `r nrow(distinct(coreview_policies))`
distinct policies in our dataset.

The following table displays stemmed parts of the distinct policies, sorted by
propensity.
```{r}
coreview_policies %>% 
  distinct() %>%
  unnest_tokens(word, coreview_policy) %>% 
  anti_join(stop_words) %>% 
  mutate(word = SnowballC::wordStem(word)) %>% 
  count(word, sort = T) 
```


The following graph shows the relationship between to most common bigrams (only
bigrams that occur at least three times).

```{r, fig.width=7, fig.height=7}
coreview_policies %>% 
  make_bigram_analysis(coreview_policy)
```




```{r, eval=FALSE}
# trigram analysis

trigrams <- coreview_policies %>% 
  distinct() %>%
  unnest_tokens(bigram, coreview_policy, token = "ngrams", n = 3)

trigrams_separated <- trigrams %>%
  separate(bigram, c("word1", "word2", "word3"), sep = " ")

trigrams_filtered <- trigrams_separated %>%
  filter(!word1 %in% stop_words$word) %>%
  filter(!word2 %in% stop_words$word) %>% 
  filter(!word3 %in% stop_words$word)


# new bigram counts:
trigram_counts <- trigrams_filtered %>% 
  count(word1, word2, word3, sort = TRUE)

trigram_counts
```



```{r}
refined %>% 
  plot_univariate(coreview_email) +
  coord_flip() +
  labs(title = "Can co-reviewers contribute?")
```

```{r, fig.width=12, fig.height=5}
refined_with_areas %>% 
  mutate(coreview_email = case_when(
    coreview_email == "unsure" ~ "Unsure",
    TRUE ~ coreview_email
  )) %>% 
  ggplot(aes(str_wrap(area, 20), fill = coreview_email)) +
  geom_bar(position = "fill", width = .7) +
  scale_fill_brewer(palette = "Set3") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "top") +
  labs(fill = NULL, x = NULL, y = NULL, 
       title = "Can co-reviewers contribute?")
```



This doesn't look interesting.
```{r}
refined %>% 
  plot_univariate(coreview_form) +
  coord_flip()
```

This doesn't look interesting.
```{r}
refined %>% 
  plot_univariate(coreview_database) +
  coord_flip()
```

# Preprints
```{r preprint version}
refined <- refined %>% 
  mutate(preprint_version_clean = case_when(
    str_detect(preprint_version, "Unsure") ~ 
      "Unsure (preprints are allowed, but it's not clear which version)",
    str_detect(preprint_version, "Any .*? or") ~ "Other",
    str_detect(preprint_version, "Other|Unclear") ~ "Other",
    str_detect(preprint_version, "None") ~ "None",
    str_detect(preprint_version, "First sub") ~ 
      "First submission only (before peer review)",
    str_detect(preprint_version, "After peer re") ~ "After peer review",
    str_detect(preprint_version, "Any|any") ~ "Any",
    str_detect(preprint_version, "No") ~ "No preprint policy",
  )) 


refined %>% 
  plot_univariate(preprint_version_clean) +
  coord_flip() +
  labs(title = "What version of a preprint\ncan be posted?")
```

```{r, fig.width=12, fig.height=6}
refined_with_areas <- refined_with_areas %>% 
  mutate(preprint_version_clean = case_when(
    str_detect(preprint_version, "Unsure") ~ 
      "Unsure (preprints are allowed, but it's not clear which version)",
    str_detect(preprint_version, "Any .*? or") ~ "Other",
    str_detect(preprint_version, "Other|Unclear") ~ "Other",
    str_detect(preprint_version, "None") ~ "None",
    str_detect(preprint_version, "First sub") ~ 
      "First submission only (before peer review)",
    str_detect(preprint_version, "After peer re") ~ "After peer review",
    str_detect(preprint_version, "Any|any") ~ "Any",
    str_detect(preprint_version, "No") ~ "No preprint policy",
  )) 


refined_with_areas %>% 
  mutate(preprint_version_clean = fct_relevel(preprint_version_clean,
                                              "Any", "After peer review") %>% 
           fct_relevel("None", "No preprint policy", "Other", after = 4))  %>% 
  plot_with_areas(preprint_version_clean, 
                  "What version of a preprint can be posted?")

```


```{r}
preprint_servers <- refined %>% 
  select(preprint_servers) %>% 
  filter(!is.na(preprint_servers),
         !(preprint_servers %in% c("Not specified", "Not found")))
```


```{r}
preprint_servers %>% 
  distinct() %>%
  unnest_tokens(word, preprint_servers) %>% 
  anti_join(stop_words) %>% 
  # mutate(word = SnowballC::wordStem(word)) %>% 
  count(word, sort = T)
```

```{r, fig.width=10, fig.height=10}
preprint_servers %>% 
  make_bigram_analysis(preprint_servers, 3, .distinct = T)
```




```{r}
refined <- refined %>% 
  mutate(preprint_citation_clean = case_when(
    str_detect(preprint_citation, "Not spec") ~ "Not specified",
    str_detect(preprint_citation, "Unsure") ~ "Unsure",
    str_detect(preprint_citation, "No") ~ "No",
    str_detect(preprint_citation, "only in the text") ~ "Yes, but only in the text",
    str_detect(preprint_citation, "reference list") ~ "Yes, in the reference list",
    is.na(preprint_citation) ~ NA_character_,
    TRUE ~ "Other"
  )) 

refined %>% 
  plot_univariate(preprint_citation_clean) +
  coord_flip() +
  labs(title = "Can preprints be cited?")
```

```{r, fig.width=12, fig.height=6}
refined_with_areas <- refined_with_areas %>% 
  mutate(preprint_citation_clean = case_when(
    str_detect(preprint_citation, "Not spec") ~ "Not specified",
    str_detect(preprint_citation, "Unsure") ~ "Unsure",
    str_detect(preprint_citation, "No") ~ "No",
    str_detect(preprint_citation, "only in the text") ~ "Yes, but only in the text",
    str_detect(preprint_citation, "reference list") ~ "Yes, in the reference list",
    is.na(preprint_citation) ~ NA_character_,
    TRUE ~ "Other"
  )) 

refined_with_areas %>% 
    mutate(preprint_citation_clean = 
             fct_relevel(preprint_citation_clean,
                         "Yes, in the reference list", "Yes, but only in the text",
                         "No", "Not specified", "Unsure", "Other")) %>% 
  plot_with_areas(preprint_citation_clean, "Can preprints be cited?")
```


```{r}
refined %>% 
  plot_univariate(preprint_link) +
  coord_flip() +
  labs(title = "Is a link provided to the preprint version of a paper?")
```

